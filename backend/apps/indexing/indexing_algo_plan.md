# Coarse Indexing: Hierarchical Semantic Bundling

## 背景与动机

PastPaper 组件结构是一棵多层语义树，包含题目、子题与细分小问。  
在构建语义索引时，若直接以单个组件为最小单元，会造成上下文割裂；  
若以整份试卷为单位，又会超出模型上下文范围。  

因此，需要一种能够在语义层次之间自适应分块的算法，用于 coarse-level 向量索引。  
目标是在保证语义完整的前提下，使每个索引单元的内容接近模型最优的上下文范围。

---

## 核心思想

算法从语义上独立的节点出发（如 Q1、Q2、Q3），  
在每个根节点下递归地聚合其直接子树。  

当父节点与其子节点的总内容在可接受的上下文范围内时，  
将它们视为一个整体 bundle；  
当聚合内容过多时，切分出多个 bundle；  
若某个子树本身过大，则将其递归地视为新的语义根继续分块。  

每一层递归都形成一个相对独立的语义森林，  
保证分块边界符合题目结构与语义逻辑。

---

## 行为描述

- 从每个语义独立的节点开始。
- 尝试将该节点及其直接子树合并为一组 bundle。
- 若聚合内容超过模型上下文的合适范围，则拆分并对过大的子树递归处理。
- 若子树内容较小且依赖父节点语义，则与父节点共同打包。
- 递归终止后，得到一组大小适中、语义完整的 bundle。

---

## 设计目标

- 生成的 bundle 既能完整表达一个题目的语义上下文，又不会过长。
- 同一层级的节点保持语义独立，形成清晰的森林结构。
- 支持后续在 bundle 层面进行向量索引与检索。

---

## 预期效果

- 向量索引的粒度更自然，召回更稳健。
- 语义相关的子节点被聚合在同一上下文中，避免丢失题干信息。
- 每份试卷分解为若干语义上连贯、长度适中的检索单元。